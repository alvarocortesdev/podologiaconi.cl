---
phase: 01-foundation-testing
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/client/vitest.config.js
  - apps/client/package.json
  - apps/server/package.json
  - packages/database/package.json
  - apps/client/src/test/setup.js
  - apps/client/src/test/utils.js
  - apps/client/src/test/fixtures/
  - apps/client/src/test/mocks/
 /src/components - apps/client/__tests__/
autonomous: true
must_haves:
  truths:
    - "npm test runs successfully"
    - "Vitest configuration integrates with existing Vite config"
    - "React Testing Library can render and test components"
    - "API mocks work for existing endpoints"
    - "Test database uses transaction rollback for isolation"
    - "Characterization tests capture existing component behavior"
  artifacts:
    - path: "apps/client/vitest.config.js"
      provides: "Vitest configuration with coverage reporting"
      min_lines: 30
    - path: "apps/client/src/test/setup.js"
      provides: "RTL custom render, providers setup, MSW initialization"
      min_lines: 50
    - path: "apps/client/src/test/utils.js"
      provides: "Test utilities (factories, fixtures, mock helpers)"
      min_lines: 100
    - path: "apps/client/src/test/mocks/handlers.js"
      provides: "MSW handlers for all API endpoints"
      min_lines: 200
    - path: "apps/client/src/test/fixtures/"
      provides: "Test fixture files"
    - path: "apps/client/src/components/__tests__/"
      provides: "Characterization tests for existing components"
    - path: "package.json"
      provides: "Updated npm scripts for testing"
  key_links:
    - from: "vitest.config.js"
      to: "vite.config.js"
      via: "extends vite config"
      pattern: "extends.*vite\\.config"
    - from: "setup.js"
      to: "test/utils.js"
      via: "imports utilities"
      pattern: "import.*utils"
    - from: "components/__tests__/"
      to: "test/mocks/handlers.js"
      via: "MSW request interception"
      pattern: "setupHandlers|msw"
    - from: "prisma test client"
      to: "test/utils.js"
      via: "transaction rollback"
      pattern: "\\$transaction|prisma\\.\\$transaction"
---

<objective>
Establish testing infrastructure (Vitest, React Testing Library, MSW, test utilities) and create characterization tests for existing components. This enables safe refactoring by providing test coverage before code changes.

Purpose: Foundation for all future refactoring work. Without tests, refactoring monolithic Admin.jsx and server/index.js would be dangerous.

Output:
- Vitest configuration integrated with existing Vite setup
- Test utilities (factories, fixtures, mocks)
- React Testing Library configuration
- MSW handlers for all existing API endpoints
- Characterization tests for existing components
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/SUMMARY.md
@.planning/phases/01-foundation-testing/01-CONTEXT.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Current Codebase State:**
- Monorepo with apps/client, apps/server, packages/database
- React 19 + Vite 6.4.0 in apps/client
- Express 5.2.1 in apps/server
- Prisma 5.10.0 in packages/database
- Zero tests currently exist
- Admin.jsx has 2,153 lines needing characterization
- Server has 862 lines with multiple API endpoints

**Existing API Endpoints to Mock:**
- POST /api/login
- POST /api/setup
- POST /api/verify-2fa
- GET /api/services (list, create, update, delete)
- GET /api/success-cases (list, create, update, delete)
- GET /api/about-cards (list, create, update, delete)
- POST /api/upload
- GET /api/config
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and configure Vitest</name>
  <files>apps/client/package.json, apps/client/vitest.config.js, package.json</files>
  <action>
Install these dependencies in apps/client:
- vitest@^4.0.0 (test runner)
- @testing-library/react@^16.2.0 (component testing)
- @testing-library/user-event@^14.0.0 (user interaction simulation)
- msw@^2.5.0 (API mocking)

Install in packages/database:
- @prisma/testing (Prisma test utilities)

Create apps/client/vitest.config.js with:
- extends from vite.config.js (essential for proper setup)
- test environment: 'jsdom' for browser simulation
- coverage provider: 'v8' (built-in, no extra install)
- coverage include: ['src/**/*.{js,jsx}', '!src/test/**']
- setupFiles: ['./src/test/setup.js']
- globals: false (use explicit imports per file)

Update package.json scripts:
- "test": "vitest"
- "test:run": "vitest run"
- "test:coverage": "vitest run --coverage"
- "test:ui": "vitest --ui" (optional dev usage)

**CRITICAL:** Do NOT use vite-plugin-vitest-globals - manually configure instead.
  </action>
  <verify>npm test -- --version shows vitest installed</verify>
  <done>Vitest installed and configured, npm test runs successfully</done>
</task>

<task type="auto">
  <name>Task 2: Create test utilities (factories, fixtures, mock helpers)</name>
  <files>apps/client/src/test/utils.js, apps/client/src/test/fixtures/, apps/client/src/test/mocks/</files>
  <action>
Create apps/client/src/test/ directory structure:

**apps/client/src/test/utils.js** (100+ lines) exports:
- `createRender()` - Custom RTL render with all providers (Router, Toast)
- `renderWithProviders()` - Variant accepting custom provider values
- `waitFor()` - Wrapper around RTL waitFor with sensible defaults
- `screen` - Re-export for convenience
- `user` - Pre-configured user-event instance

**apps/client/src/test/fixtures/services.js** exports:
- `mockService(id, data)` - Create mock service object
- `mockServices(count)` - Generate array of mock services
- `validServiceData` - Valid data for service creation
- `invalidServiceData` - Invalid data for validation testing

**apps/client/src/test/fixtures/cases.js** exports:
- `mockCase(id, data)` - Create mock success case
- `mockCases(count)` - Generate array of mock cases
- `validCaseData` - Valid data for case creation
- `mockCaseImage` - Mock image file for upload testing

**apps/client/src/test/fixtures/users.js** exports:
- `mockAdminUser()` - Mock authenticated admin user
- `mockSetupState()` - Mock 2FA setup state
- `mockToken()` - Mock JWT token

**Pattern:** All factories accept overrides for customization.
  </action>
  <verify>node -e "require('./apps/client/src/test/utils.js'); console.log('Test utilities load successfully')"</verify>
  <done>Test utilities exported and loadable, factories create valid mock objects</done>
</task>

<task type="auto">
  <name>Task 3: Configure MSW handlers for all API endpoints</name>
  <files>apps/client/src/test/mocks/handlers.js, apps/client/src/test/mocks/server.js, apps/client/src/test/setup.js</files>
  <action>
Create MSW handlers matching server API:

**apps/client/src/test/mocks/server.js**:
- Setup MSW server instance
- Use graphql or rest handlers
- Configure verbose logging in dev

**apps/client/src/test/mocks/handlers.js** (200+ lines) includes:
```javascript
// Auth handlers
http.post('/api/login', () => { /* mock login response */ }),
http.post('/api/setup', () => { /* mock setup response */ }),
http.post('/api/verify-2fa', () => { /* mock 2FA verification */ }),

// Services handlers
http.get('/api/services', () => { /* return services array */ }),
http.post('/api/services', () => { /* create service */ }),
http.put('/api/services/:id', () => { /* update service */ }),
http.delete('/api/services/:id', () => { /* delete service */ }),

// Success cases handlers
http.get('/api/success-cases', () => { /* return cases array */ }),
http.post('/api/success-cases', () => { /* create case */ }),
http.put('/api/success-cases/:id', () => { /* update case */ }),
http.delete('/api/success-cases/:id', () => { /* delete case */ }),

// About cards handlers
http.get('/api/about-cards', () => { /* return cards array */ }),
http.post('/api/about-cards', () => { /* create card */ }),
http.put('/api/about-cards/:id', () => { /* update card */ }),
http.delete('/api/about-cards/:id', () => { /* delete card */ }),

// Config and upload handlers
http.get('/api/config', () => { /* return site config */ }),
http.post('/api/upload', () => { /* mock upload response */ }),
```

Each handler returns realistic response structure matching actual API.

**apps/client/src/test/setup.js**:
- Import and setup MSW server before all tests
- Import all handlers
- Call server.listen() before tests
- Call server.close() after tests
- Clean up after each test (server.resetHandlers())
  </action>
  <verify>npm test runs -- --silent=false 2>&1 | grep -i "msw\|handler" | head -5</verify>
  <done>MSW handlers intercept all API calls, tests use mock responses</done>
</task>

</tasks>

<verification>
1. **Installation verification:**
   - `npm list vitest @testing-library/react msw` shows packages installed
   
2. **Configuration verification:**
   - `npm run test:run` exits with code 0
   - Coverage report generated in coverage/ directory
   
3. **Utility verification:**
   - All test utilities load without errors
   - Factories create valid mock objects
   
4. **Mock verification:**
   - MSW handlers intercept API calls
   - Network tab shows "(blocked)" or "(mock)" for API calls
   
5. **Integration verification:**
   - Characterization tests pass for existing components
   - Tests can render Admin.jsx with mocked auth state
</verification>

<success_criteria>
- [ ] `npm test` runs successfully
- [ ] Vitest integrates with existing Vite config (extends)
- [ ] React Testing Library renders components correctly
- [ ] MSW mocks intercept all API endpoints
- [ ] Test utilities (factories, fixtures) are reusable
- [ ] Characterization tests exist for existing components
- [ ] Coverage report shows >0% coverage
- [ ] Tests run in CI: `npm run test:run && npm run test:coverage`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-testing/01-01-SUMMARY.md`
</output>
